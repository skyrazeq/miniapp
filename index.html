<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SoundCloud Mini Player</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://w.soundcloud.com/player/api.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; padding: 10px; background-color: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); }
    input { width: 100%; padding: 12px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 8px; }
    button { width: 100%; padding: 12px; margin-bottom: 5px; background-color: var(--tg-theme-button-color, #3390ec); color: var(--tg-theme-button-text-color, #fff); border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
    .track-btn { text-align: left; background-color: var(--tg-theme-secondary-bg-color, #f0f0f0); color: var(--tg-theme-text-color, #000); margin-top: 5px; }
    #player { margin-top: 20px; }
    #error { color: red; margin-top: 10px; }
  </style>
</head>
<body>
  <h3>SoundCloud Player</h3>
  <input id="q" placeholder="Поиск (например: phonk)" />
  <button id="btn">Найти</button>
  <div id="error"></div>
  <div id="list"></div>
  <div id="player"></div>

  <script>
    // Сообщаем Telegram, что приложение готово
    Telegram.WebApp.ready(); 
    Telegram.WebApp.expand(); // По желанию разворачиваем на весь экран

    // Твой URL от туннеля (меняй его, если перезапускаешь cloudflared)
    const API_BASE = "https://bases-die-gentle-spell.trycloudflare.com";

    let widget = null;

    function mountPlayer(scUrl) {
      const playerDiv = document.getElementById("player");
      playerDiv.innerHTML = ""; // Очистка старого плеера

      const iframe = document.createElement("iframe");
      iframe.width = "100%";
      iframe.height = "166";
      iframe.allow = "autoplay";
      iframe.src = `https://w.soundcloud.com/player/?url=${encodeURIComponent(scUrl)}&auto_play=true&show_artwork=true`;
      
      playerDiv.appendChild(iframe);
      
      // Инициализация Widget API для управления
      widget = SC.Widget(iframe);
      widget.bind(SC.Widget.Events.FINISH, () => {
        console.log("Трек закончился");
        // Тут можно логику включения следующего трека
      });
    }

    document.getElementById("btn").onclick = async () => {
      const q = document.getElementById("q").value.trim();
      const list = document.getElementById("list");
      const errDiv = document.getElementById("error");
      
      if (!q) return;

      list.innerHTML = "Загрузка...";
      errDiv.innerText = "";

      try {
        // Добавляем initData для валидации (если backend включил проверку)
        const r = await fetch(`${API_BASE}/search?q=${encodeURIComponent(q)}&n=10`, {
           headers: {
             "X-Telegram-Init-Data": Telegram.WebApp.initData
           }
        });
        
        if (!r.ok) throw new Error(`Ошибка сервера: ${r.status}`);
        
        const data = await r.json();
        list.innerHTML = "";

        if (!data.items || data.items.length === 0) {
          list.innerHTML = "Ничего не найдено.";
          return;
        }

        data.items.forEach(t => {
          const b = document.createElement("button");
          b.className = "track-btn";
          b.textContent = t.title || "Без названия";
          b.onclick = () => mountPlayer(t.url);
          list.appendChild(b);
        });

      } catch (e) {
        list.innerHTML = "";
        errDiv.innerText = "Ошибка: " + e.message + ". Проверь, запущен ли туннель!";
      }
    };
  </script>
</body>
</html>
